name: Convert Help HTML to Wiki

on:
  push:
    branches:
      - main
    paths:
      - 'help/**'
  workflow_dispatch:

jobs:
  convert-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Install html-to-markdown converter
        run: |
          npm install turndown

      - name: Convert HTML to Markdown
        run: |
          mkdir -p wiki-output
          
          # 创建转换脚本
          cat > convert.js << 'EOF'
          const TurndownService = require('turndown');
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');
          
          const turndownService = new TurndownService({
            headingStyle: 'atx',
            codeBlockStyle: 'fenced',
            bulletListMarker: '-'
          });
          
          // 自定义规则：保留图片
          turndownService.addRule('images', {
            filter: 'img',
            replacement: function (content, node) {
              const alt = node.getAttribute('alt') || '';
              const src = node.getAttribute('src') || '';
              if (src) {
                return `![${alt}](${src})`;
              }
              return '';
            }
          });
          
          function convertHtmlToMarkdown(htmlFile, mdFile) {
            try {
              // 先尝试使用 pandoc
              try {
                execSync(`pandoc "${htmlFile}" -f html -t markdown --wrap=none -o "${mdFile}"`, { stdio: 'ignore' });
                console.log(`Converted ${htmlFile} using pandoc`);
                return;
              } catch (e) {
                // pandoc 失败，使用 turndown
              }
              
              // 使用 turndown 转换
              const html = fs.readFileSync(htmlFile, 'utf8');
              let markdown = turndownService.turndown(html);
              
              // 清理 Markdown
              // 移除空链接
              markdown = markdown.replace(/\[([^\]]+)\]\(\)/g, '$1');
              // 移除多余的空白行
              markdown = markdown.replace(/\n{3,}/g, '\n\n');
              
              fs.writeFileSync(mdFile, markdown, 'utf8');
              console.log(`Converted ${htmlFile} using turndown`);
            } catch (error) {
              console.error(`Error converting ${htmlFile}:`, error.message);
            }
          }
          
          // 转换所有语言的 HTML 文件
          const helpDir = 'help/SwiftCraftLauncher.help/Contents/Resources';
          const langDirs = fs.readdirSync(helpDir).filter(dir => dir.endsWith('.lproj'));
          
          langDirs.forEach(langDir => {
            const lang = langDir.replace('.lproj', '');
            const langPath = path.join(helpDir, langDir);
            const outputDir = path.join('wiki-output', lang);
            
            if (!fs.existsSync(outputDir)) {
              fs.mkdirSync(outputDir, { recursive: true });
            }
            
            const htmlFiles = fs.readdirSync(langPath).filter(file => file.endsWith('.html'));
            
            htmlFiles.forEach(htmlFile => {
              const htmlPath = path.join(langPath, htmlFile);
              const mdFile = path.basename(htmlFile, '.html') + '.md';
              const mdPath = path.join(outputDir, mdFile);
              
              convertHtmlToMarkdown(htmlPath, mdPath);
            });
          });
          EOF
          
          # 运行转换脚本
          node convert.js

      - name: Clone wiki repository
        env:
          # 优先使用 PAT，如果没有则使用 GITHUB_TOKEN
          WIKI_TOKEN: ${{ secrets.WIKI_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # 使用 token 克隆 wiki 仓库
          if git clone https://x-access-token:${WIKI_TOKEN}@github.com/suhang12332/Swift-Craft-Launcher.wiki.git wiki-repo 2>/dev/null; then
            echo "Wiki repository cloned successfully"
          else
            echo "Wiki repository does not exist or is empty, creating new one"
            mkdir -p wiki-repo
            cd wiki-repo
            git init
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git remote add origin https://x-access-token:${WIKI_TOKEN}@github.com/suhang12332/Swift-Craft-Launcher.wiki.git
            cd ..
          fi
          
          cd wiki-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # 设置远程 URL 使用 token
          git remote set-url origin https://x-access-token:${WIKI_TOKEN}@github.com/suhang12332/Swift-Craft-Launcher.wiki.git

      - name: Copy converted files to wiki repository
        run: |
          # 清空 wiki 仓库（保留 .git）
          cd wiki-repo
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # 复制转换后的文件
          cp -r ../wiki-output/* .
          
          # 创建或更新 README.md
          if [ ! -f README.md ]; then
            echo "# Swift Craft Launcher Wiki" > README.md
            echo "" >> README.md
            echo "This wiki is automatically generated from the help documentation." >> README.md
          fi

      - name: Commit and push to wiki repository
        env:
          # 优先使用 PAT，如果没有则使用 GITHUB_TOKEN
          WIKI_TOKEN: ${{ secrets.WIKI_PAT || secrets.GITHUB_TOKEN }}
        run: |
          cd wiki-repo
          
          # 清除任何缓存的凭据
          git config --unset credential.helper || true
          git config --global --unset credential.helper || true
          
          # 构建带 token 的 URL
          WIKI_URL="https://x-access-token:${WIKI_TOKEN}@github.com/suhang12332/Swift-Craft-Launcher.wiki.git"
          
          # 确保远程 URL 使用 token
          git remote set-url origin "$WIKI_URL"
          
          # 验证远程 URL 已更新
          echo "Remote URL configured: $(git remote get-url origin | sed 's/:[^@]*@/:***@/')"
          
          git add -A
          
          # 检查是否有更改
          if git diff --staged --quiet; then
            if [ -z "$(git ls-files)" ]; then
              echo "No files in repository, creating initial commit"
              git commit --allow-empty -m "Initial commit: Convert help HTML to Markdown [skip ci]"
            else
              echo "No changes to commit"
              exit 0
            fi
          else
            git commit -m "Auto-update: Convert help HTML to Markdown [skip ci]"
          fi
          
          # 检查当前分支，如果没有则创建 master 分支
          current_branch=$(git branch --show-current 2>/dev/null || echo "")
          if [ -z "$current_branch" ]; then
            git checkout -b master
            current_branch="master"
          fi
          
          # 使用 credential helper 来提供 token
          git config credential.helper "!f() { echo 'username=x-access-token'; echo 'password=${WIKI_TOKEN}'; }; f"
          
          # 尝试推送到当前分支
          echo "Pushing to branch: $current_branch"
          echo "Using token authentication..."
          
          # 直接使用 URL 推送，确保使用 token
          if git push "$WIKI_URL" $current_branch:$current_branch; then
            echo "Successfully pushed to wiki repository"
            # 更新远程跟踪分支
            git branch --set-upstream-to=origin/$current_branch $current_branch || true
          else
            # 如果失败，尝试推送到 master 或 main
            echo "Failed to push to $current_branch, trying master..."
            if git push "$WIKI_URL" master:master 2>/dev/null; then
              echo "Successfully pushed to master branch"
              git checkout master 2>/dev/null || true
            elif git push "$WIKI_URL" main:main 2>/dev/null; then
              echo "Successfully pushed to main branch"
              git checkout main 2>/dev/null || true
            else
              echo "Error: Failed to push to wiki repository"
              echo ""
              echo "Debug information:"
              echo "Token present: $([ -n "${WIKI_TOKEN}" ] && echo 'Yes' || echo 'No')"
              echo "Token length: ${#WIKI_TOKEN}"
              echo "Remote URL: $(git remote get-url origin | sed 's/:[^@]*@/:***@/')"
              echo ""
              echo "Please check:"
              echo "1. The wiki repository exists and is accessible"
              echo "2. You have set up a Personal Access Token (PAT) with 'repo' scope in repository secrets as 'WIKI_PAT'"
              echo "3. The PAT must have write access to the wiki repository"
              echo "4. To create a PAT: https://github.com/settings/tokens (select 'repo' scope)"
              exit 1
            fi
          fi

