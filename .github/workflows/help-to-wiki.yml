name: Publish Help (HTML → Wiki Markdown)

on:
  workflow_dispatch:
  push:
    paths:
      - "help/SwiftCraftLauncher.help/Contents/Resources/en.lproj/**"
      - ".github/scripts/**"

permissions:
  contents: write

concurrency:
  group: publish-help-to-wiki
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout assets repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Convert HTML to Markdown (GFM)
        shell: bash
        run: |
          set -euo pipefail

          SRC_DIR="help/SwiftCraftLauncher.help/Contents/Resources/en.lproj"
          OUT_DIR="_wiki_help"
          SCRIPT_DIR=".github/scripts"
          mkdir -p "$OUT_DIR"

          shopt -s nullglob
          for f in "$SRC_DIR"/*.html; do
            [[ -e "$f" ]] || continue
            base="$(basename "$f" .html)"

            out_name="$base.md"
            if [[ "$base" == "index" ]]; then
              out_name="home.md"
            fi

            out="$OUT_DIR/$out_name"
            tmp_preprocessed="$OUT_DIR/pre_${base}.html"
            map_file="$OUT_DIR/.img_${base}.map"

            echo "转换: $base.html -> $out_name"

            # 1. 预处理：用 span 占位符替换 img，pandoc 会保留 span
            perl "$SCRIPT_DIR/help-to-md-preprocess.pl" "$f" "$tmp_preprocessed" "$map_file"

            # 2. pandoc 转换
            pandoc "$tmp_preprocessed" \
              --from=html \
              --to=gfm+raw_html \
              --wrap=none \
              -o "$out"

            # 3. 后处理：恢复 img 标签，app-icon 64x64，topicIcon 48x48
            perl "$SCRIPT_DIR/help-to-md-postprocess.pl" "$out" "$map_file"
            rm -f "$map_file" "$tmp_preprocessed" 2>/dev/null || true

            # 4. 调整内部链接以适配 GitHub Wiki，统一使用 home（不用 index）
            perl -pi -e '
              s/\]\(((?!https?:\/\/)[^)]*?)index\.html(\))/\]\(\1home\2/g;
              s/\]\(((?!https?:\/\/)[^)]*?)index\.html(#)/\]\(\1home\2/g;
              s/\]\(((?!https?:\/\/)[^)]*?)\.html(\))/\]\(\1\2/g;
              s/\]\(((?!https?:\/\/)[^)]*?)\.html(#)/\]\(\1\2/g;
              s/\]\(home(\#[^)]*)\)/\](home.md$1)/g;
              s/\]\(home\)/\](home.md)/g;
              s/href="index\.html"/href="home"/g;
              s/href="index\.html#/href="home#/g;
              s/href="home#index"/href="home"/g;
              s/id="index"/id="home"/g;
            ' "$out" 2>/dev/null || true
          done

      - name: Publish to GitHub Wiki repo
        env:
          WIKI_REPO: suhang12332/Swift-Craft-Launcher.wiki
          WIKI_PAT: ${{ secrets.WIKI_PAT }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${WIKI_PAT:-}" ]]; then
            echo "Missing secret WIKI_PAT. Add your existing PAT as a repository secret named WIKI_PAT."
            exit 1
          fi

          # 为当前 runner 设置全局 git 身份，避免 Author identity unknown
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git clone "https://x-access-token:${WIKI_PAT}@github.com/${WIKI_REPO}.git" wiki

          # 覆盖 wiki 主仓库根目录（不再使用子目录）
          cp -R "_wiki_help/." "wiki/"

          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No wiki changes to publish."
            exit 0
          fi
          git commit -m "Update help docs (HTML → Markdown)"
          git push

      - name: Remove HTML files after conversion
        run: |
          set -euo pipefail
          SRC_DIR="help/SwiftCraftLauncher.help/Contents/Resources/en.lproj"
          rm -f "$SRC_DIR"/*.html
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No HTML files to remove."
            exit 0
          fi
          git commit -m "Remove HTML files (converted to Wiki Markdown)"
          git push

